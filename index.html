<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Quiet moves</title>
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Gilda+Display&display=swap" rel="stylesheet">
  <style>
    .gilda-display-regular {
      font-family: "Gilda Display", serif;
      font-weight: 400;
      font-style: normal;
    }
    .flex-item {
      min-height: 1em;
    }
    .main-flex {
      touch-action:none;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 10px;
    }
  </style>
</head>
<body>

<div id="main" class="main-flex">
  <div id="textBox" class="gilda-display-regular" style="font-size:4rem;">Chess zen</div>
  <div id="solutionText" class="gilda-display-regular" style="font-size:1.5rem; visibility: hidden;"><p>Not quite the right move, try again.</p></div>
  <div id="myBoard" style="width:700px;"></div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
        integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
        crossorigin="anonymous"></script>

<script type="module">
      import init, { Puzzle } from './chess_riddler_rs.js';

      let puzzle;
      let solved = false;
      let next_move;

      function onDragStart (source, piece, position, orientation) {
        if (solved === true) {
          return false;
        }
        var currentSide = puzzle.current_side()
        if ((currentSide === 'white' && piece.search(/^w/) === -1) ||
            (currentSide === 'black' && piece.search(/^b/) === -1)) {
          return false
        }
      }

      function uciToInternal(uci) {
        if (uci.length != 4) {
          return null;
        }
        return uci.slice(0,2) + "-" + uci.slice(2,4);
      }

      async function run() {
        await init();
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`./puzzles/${today}.json`);
        if (!response.ok){
          document.getElementById("textBox").innerHTML =  "<p>No puzzle available for today! Come back tomorrow.</p>";
          return;
        }
        const json = await response.text();
        puzzle = Puzzle.from_json(json);
        var config = {
            draggable: true,
            pieceTheme: 'img/chesspieces/{piece}.svg',
            dropOffBoard: 'snapback',
            position: puzzle.get_initial_fen(),
            orientation : puzzle.current_side(),
            onDrop: ((source, target, piece, newPos, oldPos, orientation) => {
                    next_move = puzzle.attempt_uci_move(source+target);
                    if (!next_move) {
                      var solutionItem = document.getElementById("solutionText");
                      solutionItem.innerHTML = "<p>Not quite the best move. Try again.</p>";
                      solutionItem.style.visibility = "visible";
                      return 'snapback';
                    }
                    else if (next_move === "Solved") {
                      next_move = newPos;
                      var solutionItem = document.getElementById("solutionText");
                      solutionItem.innerHTML =  "<p>You solved the puzzle, that was it!</p>";
                      solutionItem.style.visibility = "visible";
                      solved = true;
                    }
                    else {
                      var solutionItem = document.getElementById("solutionText");
                      solutionItem.innerHTML =  "<p>Good! Keep going!</p>";
                      solutionItem.style.visibility = "visible";
                    }
            }),
            onSnapEnd: ((oldPos, newPos) => {
              if (next_move && next_move != "Solved") {
                board.position(next_move);
              }
            }),
            onDragStart: onDragStart
        }
        var board = Chessboard('myBoard', config);
        board.position(puzzle.get_fen());
      }

      run();
</script>
</body>
</html>
