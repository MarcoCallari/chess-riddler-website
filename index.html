<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Quiet moves</title>
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
</head>
<body>

<div id="main" style="touch-action:none;">
  <div id="myBoard" style="width: 800px; overflow-x: hidden; max-width: 100%; overflow-y:hidden;"></div>
  <div id="textBox"></div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
        integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
        crossorigin="anonymous"></script>

<script type="module">
      import init, { Puzzle } from './chess_riddler_rs.js';

      let puzzle;
      let solved = false;
      let next_move;

      function onDragStart (source, piece, position, orientation) {
        if (solved === true) {
          return false;
        }
        var currentSide = puzzle.current_side()
        if ((currentSide === 'white' && piece.search(/^w/) === -1) ||
            (currentSide === 'black' && piece.search(/^b/) === -1)) {
          return false
        }
      }

      function uciToInternal(uci) {
        if (uci.length != 4) {
          return null;
        }
        return uci.slice(0,2) + "-" + uci.slice(2,4);
      }

      async function run() {
        await init();
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`./puzzles/${today}.json`);
        if (!response.ok){
          document.getElementById("textBox").innerHTML =  "<p>No puzzle available for today! Come back tomorrow.</p>";
          return;
        }
        const json = await response.text();
        puzzle = Puzzle.from_json(json);
        var config = {
            draggable: true,
            pieceTheme: 'img/chesspieces/{piece}.svg',
            dropOffBoard: 'snapback',
            position: puzzle.get_initial_fen(),
            orientation : puzzle.current_side(),
            onDrop: ((source, target, piece, newPos, oldPos, orientation) => {
                    next_move = puzzle.attempt_uci_move(source+target);
                    if (!next_move ) { return 'snapback'; }
                    else if (next_move === "Solved") {
                      console.log(newPos)
                      next_move = newPos;
                      document.getElementById("textBox").innerHTML =  "<p>You got it, that was it.</p>";
                      solved = true;
                    }
            }),
            onSnapEnd: ((oldPos, newPos) => {
              console.log("end");
              if (next_move && next_move != "Solved") {
                board.position(next_move);
              }
            }),
            onDragStart: onDragStart
        }
        var board = Chessboard('myBoard', config);
        board.position(puzzle.get_fen());
      }

      run();
</script>
</body>
</html>
